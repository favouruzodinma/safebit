<?php
// Include your database connection file (e.g., _db.php)
require_once("../_db.php");

// Function to send email notification
function sendEmailNotification($to, $subject, $message) {
    // Set additional headers if needed
    $headers = "MIME-Version: 1.0\r\n";
    $headers .= "Content-type: text/html; charset=utf-8\r\n";

    // Send the to
    return mail($to, $subject, $message, $headers);
}

// Assuming you pass the payment ID as a query parameter
$paymentId = $_GET['payment_id'];

// Fetch payment details from the database based on payment ID
$stmt = $conn->prepare("SELECT * FROM user_history WHERE id = ?");
if ($stmt) {
    $stmt->bind_param("s", $paymentId);
    $stmt->execute();
    $result = $stmt->get_result();
    $payment = $result->fetch_assoc();
    $stmt->close();

    if ($payment) {
        if ($payment['status'] == 'pending') {
            // Update payment status to approved
            $updateStmt = $conn->prepare("UPDATE user_history SET status = 'approved' WHERE id = ?");
            if ($updateStmt) {
                $updateStmt->bind_param("s", $paymentId);
                $updateStmt->execute();

                // Subtract the approved amount from the user's coin balance
                $coinType = $payment['coinType'];
                $amount = $payment['amount'];
                $userId = $payment['userid'];

                $updateBalanceStmt = $conn->prepare("UPDATE user_login SET `{$coinType}_balance` = `{$coinType}_balance` - ? WHERE userid = ?");
                if ($updateBalanceStmt) {
                    $updateBalanceStmt->bind_param("ds", $amount, $userId);
                    $updateBalanceStmt->execute();
                    $updateBalanceStmt->close();

                    // Additional logic after approval if needed

                    // Send email notification
                    $to = $payment['email']; // Replace with the actual column name for user email
                    $subject = 'Payment Approved';
                    $message = 'Your payment has been approved. Thank you for your transaction!';
                    if (sendEmailNotification($to, $subject, $message)) {
                        echo "Payment approved successfully, and email sent!";
                    } else {
                        echo "Payment approved successfully, but failed to send email.";
                    }
                } else {
                    echo "Error updating user's balance: " . $conn->error;
                }

                $updateStmt->close();
            } else {
                echo "Error updating payment status: " . $conn->error;
            }
        } elseif ($payment['status'] == 'approved') {
            echo "Payment already approved.";
        } elseif ($payment['status'] == 'declined') {
            echo "Payment already declined.";
        }
    } else {
        echo "Payment not found.";
    }
} else {
    echo "Error fetching payment details: " . $conn->error;
}

// Close your database connection
$conn->close();
?>
